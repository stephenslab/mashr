<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Accounting for correlations among measurements • mashr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Accounting for correlations among measurements">
<meta property="og:description" content="mashr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mashr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.50</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/stephenslab/mashr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="intro_correlations_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Accounting for correlations among measurements</h1>
                        <h4 class="author">Matthew Stephens</h4>
            
            <h4 class="date">2021-07-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stephenslab/mashr/blob/master/vignettes/intro_correlations.Rmd"><code>vignettes/intro_correlations.Rmd</code></a></small>
      <div class="hidden name"><code>intro_correlations.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>In some settings measurements and tests in different conditions may be correlated with one another. For example, in eQTL applications this can occur due to sample overlap among the different conditions.</p>
<p>Failure to deal with such correlations can cause false positives in a <code>mashr</code> analysis.</p>
<p>To deal with these correlations <code>mashr</code> allows the user to specify a correlation matrix <span class="math inline">\(V\)</span> when setting up the data in <code>mash_set_data</code>. We introduce two methods to estimate this correlation matrix. The first method is simple and fast. It estimates the correlation matrix using <code>estimate_null_correlation_simple</code>, which, as its name suggests, uses the null tests (specifically, tests without a strong <span class="math inline">\(z\)</span> score) to estimate the correlations. The second method may provide a better <code>mash</code> fit. It estimates the correlations using <code>mash_estimate_corr_em</code>, which uses an ad hoc EM algorithm.</p>
</div>
<div id="method-1" class="section level1">
<h1 class="hasAnchor">
<a href="#method-1" class="anchor"></a>Method 1</h1>
<p>The method is described in <a href="https://www.biorxiv.org/content/10.1101/096552v2">Urbut et al.</a></p>
<p>Here we simulate data with correlations.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stephenslab/mashr">mashr</a></span><span class="op">)</span></code></pre></div>
<pre><code># Loading required package: ashr</code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">simdata</span> <span class="op">=</span> <span class="fu"><a href="../reference/simple_sims.html">simple_sims</a></span><span class="op">(</span><span class="fl">500</span>,<span class="fl">5</span>,<span class="fl">1</span><span class="op">)</span>
<span class="va">V</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">5</span>,<span class="fl">5</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span> <span class="op">=</span> <span class="fl">1</span>
<span class="va">simdata</span><span class="op">$</span><span class="va">Bhat</span> <span class="op">=</span> <span class="va">simdata</span><span class="op">$</span><span class="va">B</span> <span class="op">+</span> <span class="fu">mvtnorm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html">rmvnorm</a></span><span class="op">(</span><span class="fl">2000</span>, sigma <span class="op">=</span> <span class="va">V</span><span class="op">)</span></code></pre></div>
<p>Read in the data, and estimate correlations:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span>   <span class="op">=</span> <span class="fu"><a href="../reference/mash_set_data.html">mash_set_data</a></span><span class="op">(</span><span class="va">simdata</span><span class="op">$</span><span class="va">Bhat</span>, <span class="va">simdata</span><span class="op">$</span><span class="va">Shat</span><span class="op">)</span>
<span class="va">V.simple</span> <span class="op">=</span> <span class="fu"><a href="../reference/estimate_null_correlation_simple.html">estimate_null_correlation_simple</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
<span class="va">data.Vsimple</span> <span class="op">=</span> <span class="fu"><a href="../reference/mash_update_data.html">mash_update_data</a></span><span class="op">(</span><span class="va">data</span>, V<span class="op">=</span><span class="va">V.simple</span><span class="op">)</span></code></pre></div>
<p>Now we have two mash data objects, one (<code>data.Vsimple</code>) with correlations specified, and one without (<code>data</code>). So analyses using <code>data.Vsimple</code> will allow for correlations, whereas analyses using <code>data</code> will assume measurements are independent.</p>
<p>Here, for illustration purposes, we proceed to analyze the data with correlations, using just the simple canonical covariances as in the initial <a href="intro_mash.html">introductory vignette</a>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">U.c</span> <span class="op">=</span> <span class="fu"><a href="../reference/cov_canonical.html">cov_canonical</a></span><span class="op">(</span><span class="va">data.Vsimple</span><span class="op">)</span> 
<span class="va">m.Vsimple</span> <span class="op">=</span> <span class="fu"><a href="../reference/mash.html">mash</a></span><span class="op">(</span><span class="va">data.Vsimple</span>, <span class="va">U.c</span><span class="op">)</span> <span class="co"># fits with correlations because data.V includes correlation information </span></code></pre></div>
<pre><code>#  - Computing 2000 x 151 likelihood matrix.
#  - Likelihood calculations took 0.05 seconds.
#  - Fitting model with 151 mixture components.
#  - Model fitting took 0.58 seconds.
#  - Computing posterior matrices.
#  - Computation allocated took 0.02 seconds.</code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ashr/man/get_lfdr.html">get_loglik</a></span><span class="op">(</span><span class="va">m.Vsimple</span><span class="op">)</span>,digits<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="co"># log-likelihood of the fit with correlations set to V</span></code></pre></div>
<pre><code># [1] -14689.87712</code></pre>
<p>We can also compare with the original analysis. (Note that the canonical covariances do not depend on the correlations, so we can use the same <code>U.c</code> here for both analyses. If we used data-driven covariances we might prefer to estimate these separately for each analysis as the correlations would affect them.)</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m.orig</span> <span class="op">=</span> <span class="fu"><a href="../reference/mash.html">mash</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">U.c</span><span class="op">)</span> <span class="co"># fits without correlations because data object was set up without correlations</span></code></pre></div>
<pre><code>#  - Computing 2000 x 151 likelihood matrix.
#  - Likelihood calculations took 0.04 seconds.
#  - Fitting model with 151 mixture components.
#  - Model fitting took 0.65 seconds.
#  - Computing posterior matrices.
#  - Computation allocated took 0.02 seconds.</code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ashr/man/get_lfdr.html">get_loglik</a></span><span class="op">(</span><span class="va">m.orig</span><span class="op">)</span>,digits<span class="op">=</span><span class="fl">10</span><span class="op">)</span></code></pre></div>
<pre><code># [1] -14904.79133</code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">loglik</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ashr/man/get_lfdr.html">get_loglik</a></span><span class="op">(</span><span class="va">m.orig</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/ashr/man/get_lfdr.html">get_loglik</a></span><span class="op">(</span><span class="va">m.Vsimple</span><span class="op">)</span><span class="op">)</span>
<span class="va">significant</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_significant_results.html">get_significant_results</a></span><span class="op">(</span><span class="va">m.orig</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_significant_results.html">get_significant_results</a></span><span class="op">(</span><span class="va">m.Vsimple</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">false_positive</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_significant_results.html">get_significant_results</a></span><span class="op">(</span><span class="va">m.orig</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">501</span><span class="op">)</span>, 
                   <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_significant_results.html">get_significant_results</a></span><span class="op">(</span><span class="va">m.Vsimple</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">501</span><span class="op">)</span><span class="op">)</span>
<span class="va">tb</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">loglik</span>, <span class="va">significant</span>, <span class="va">false_positive</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">tb</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'without cor'</span>, <span class="st">'V simple'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/row.names.html">row.names</a></span><span class="op">(</span><span class="va">tb</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'log likelihood'</span>, <span class="st">'# significance'</span>, <span class="st">'# False positive'</span><span class="op">)</span>
<span class="va">tb</span></code></pre></div>
<pre><code>#                  without cor  V simple
# log likelihood     -14904.79 -14689.88
# # significance        410.00     89.00
# # False positive       62.00      2.00</code></pre>
<p>The log-likelihood with correlations is higher than without correlations. The false positives reduce.</p>
</div>
<div id="method-2" class="section level1">
<h1 class="hasAnchor">
<a href="#method-2" class="anchor"></a>Method 2</h1>
<p>The method is described in Yuxin Zou’s thesis.</p>
<p>To estimate the residual correlations using EM method, it requires covariance matrices for the signals. We proceed with the simple canonical covariances.</p>
<p>With <code>details = TRUE</code> in <code>mash_estimate_corr_em</code>, it returns the estimates residual correlation matrix with the mash fit.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">V.em</span> <span class="op">=</span> <span class="fu"><a href="../reference/mash_estimate_corr_em.html">mash_estimate_corr_em</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">U.c</span>, details <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">m.Vem</span> <span class="op">=</span> <span class="va">V.em</span><span class="op">$</span><span class="va">mash.model</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ashr/man/get_lfdr.html">get_loglik</a></span><span class="op">(</span><span class="va">m.Vem</span><span class="op">)</span>,digits<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="co"># log-likelihood of the fit</span></code></pre></div>
<pre><code># [1] -14654.32361</code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">loglik</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ashr/man/get_lfdr.html">get_loglik</a></span><span class="op">(</span><span class="va">m.orig</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/ashr/man/get_lfdr.html">get_loglik</a></span><span class="op">(</span><span class="va">m.Vsimple</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/ashr/man/get_lfdr.html">get_loglik</a></span><span class="op">(</span><span class="va">m.Vem</span><span class="op">)</span><span class="op">)</span>
<span class="va">significant</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_significant_results.html">get_significant_results</a></span><span class="op">(</span><span class="va">m.orig</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_significant_results.html">get_significant_results</a></span><span class="op">(</span><span class="va">m.Vsimple</span><span class="op">)</span><span class="op">)</span>,
                <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_significant_results.html">get_significant_results</a></span><span class="op">(</span><span class="va">m.Vem</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">false_positive</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_significant_results.html">get_significant_results</a></span><span class="op">(</span><span class="va">m.orig</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">501</span><span class="op">)</span>, 
                   <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_significant_results.html">get_significant_results</a></span><span class="op">(</span><span class="va">m.Vsimple</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">501</span><span class="op">)</span>,
                   <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_significant_results.html">get_significant_results</a></span><span class="op">(</span><span class="va">m.Vem</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">501</span><span class="op">)</span><span class="op">)</span>
<span class="va">tb</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">loglik</span>, <span class="va">significant</span>, <span class="va">false_positive</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">tb</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'without cor'</span>, <span class="st">'V simple'</span>, <span class="st">'V EM'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/row.names.html">row.names</a></span><span class="op">(</span><span class="va">tb</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'log likelihood'</span>, <span class="st">'# significance'</span>, <span class="st">'# False positive'</span><span class="op">)</span>
<span class="va">tb</span></code></pre></div>
<pre><code>#                  without cor  V simple      V EM
# log likelihood     -14904.79 -14689.88 -14654.32
# # significance        410.00     89.00     95.00
# # False positive       62.00      2.00      0.00</code></pre>
<p>Comparing with Method 1, the log likelihood from Method 2 is higher.</p>
<p>The EM updates in <code>mash_estimate_corr_em</code> needs some time to converge. There are several things we can do to reduce the running time. First of all, we can set the number of iterations to a small number. Because there is a large improvement in the log-likelihood within the first few iterations, running the algorithm with small number of iterations provides estimates of correlation matrix that is better than the initial value. Moreover, we can estimate the correlation matrix using a random subset of genes, not the whole observed genes.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Matthew Stephens, Sarah Urbut, Gao Wang, Yuxin Zou, Peter Carbonetto.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
