<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>mashr with common baseline • mashr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="mashr with common baseline">
<meta property="og:description" content="mashr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mashr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.73</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/stephenslab/mashr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>mashr with common baseline</h1>
                        <h4 data-toc-skip class="author">Yuxin Zou</h4>
            
            <h4 data-toc-skip class="date">2023-08-16</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stephenslab/mashr/blob/HEAD/vignettes/intro_mashcommonbaseline.Rmd" class="external-link"><code>vignettes/intro_mashcommonbaseline.Rmd</code></a></small>
      <div class="hidden name"><code>intro_mashcommonbaseline.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette illustrates how to use <code>mashr</code> to estimate
the change in some quantity measured in multiple conditions compared
with a <strong>common</strong> control condition.</p>
<p>We assume that we have measurements in multiple conditions, and want
to estimate the deviation in each condition from the control: that is,
the difference in mean between that condition and the control condition.
When we compare every condition to the same control then the observed
deviations are correlated with one another (even under the null where
there are no true differences among conditions). These correlations, if
not properly accounted for, can lead to many false positives in a
multivariate analysis. This vignette illustrates how to properly account
for such correlations.</p>
<p>Here is the <a href="https://stephenslab.github.io/mashr/articles/MASH_baseline.pdf" class="external-link">write-up</a>
for the details of the/ model. When there is no control condition in the
study, we can compare the quantity in different conditions with the
mean. We illustrate an example in the <a href="intro_mashbaselinemean.html">common baseline at the mean
vignette</a>.</p>
<p>To deal with these correlations, mashr allows the user to specify the
reference condition using <code>mash_update_data</code>, after setting
up the data in <code>mash_set_data</code>.</p>
<p><strong>Note</strong>: The correlations in deviations induced by
comparing to a common baseline/control occur even if the measurements in
different conditions are entirely independent. If the measurements in
different conditions are also correlated with one another (eg in eQTL
applications this can occur due to sample overlap among the different
conditions) then this induces additional correlations into the analysis
that should also be taken into account. In <code>common baseline</code>
analysis, such additional correlations can be specified by the user (we
have not yet implemented methods to estimate this additional correlation
from the data).</p>
</div>
<div class="section level2">
<h2 id="illustration">Illustration<a class="anchor" aria-label="anchor" href="#illustration"></a>
</h2>
<p>Here we simulate data for illustration. This simulation routine
creates a dataset with 8 conditions and 12000 samples, the last
condition is the control condition. 90% of the samples have no
deviations from the control condition. The remaining 10% of the samples
are “non-null”, and consist of equal numbers of three different types of
deviations: equal among conditions <span class="math inline">\(1,
\cdots, 7\)</span>, present only in condition 1, independent across
conditions <span class="math inline">\(1, \cdots, 7\)</span>.</p>
<p>Our goal is to estimate the deviations in condition <span class="math inline">\(1, \cdots, 7\)</span> compared with the control
condition.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/stephenslab/mashr" class="external-link">mashr</a></span><span class="op">)</span></code></pre></div>
<pre><code><span class="co"># Loading required package: ashr</span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">simdata</span> <span class="op">=</span> <span class="fu"><a href="../reference/sim_contrast2.html">sim_contrast2</a></span><span class="op">(</span>nsamp <span class="op">=</span> <span class="fl">12000</span>, ncond <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></code></pre></div>
<p>We demonstrate the right way and the wrong to do the analysis</p>
</div>
<div class="section level2">
<h2 id="the-right-way">The right way<a class="anchor" aria-label="anchor" href="#the-right-way"></a>
</h2>
<p>Read in the data, and set the control condition</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="../reference/mash_set_data.html">mash_set_data</a></span><span class="op">(</span><span class="va">simdata</span><span class="op">$</span><span class="va">Chat</span>, <span class="va">simdata</span><span class="op">$</span><span class="va">Shat</span><span class="op">)</span>

<span class="va">data.L</span> <span class="op">=</span> <span class="fu"><a href="../reference/mash_update_data.html">mash_update_data</a></span><span class="op">(</span><span class="va">data</span>, ref <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></code></pre></div>
<p>The updated mash data object (<code>data.L</code>) includes the
induced correlation internally.</p>
<p>We proceed the analysis using just the simple canonical covariances
as in the <a href="intro_mash.html">initial introductory</a>
vignette.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">U.c</span> <span class="op">=</span> <span class="fu"><a href="../reference/cov_canonical.html">cov_canonical</a></span><span class="op">(</span><span class="va">data.L</span><span class="op">)</span>
<span class="va">mashcontrast.model</span> <span class="op">=</span> <span class="fu"><a href="../reference/mash.html">mash</a></span><span class="op">(</span><span class="va">data.L</span>, <span class="va">U.c</span>, algorithm.version <span class="op">=</span> <span class="st">'R'</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">#  - Computing 12000 x 181 likelihood matrix.</span>
<span class="co">#  - Likelihood calculations took 1.02 seconds.</span>
<span class="co">#  - Fitting model with 181 mixture components.</span>
<span class="co">#  - Model fitting took 5.58 seconds.</span>
<span class="co">#  - Computing posterior matrices.</span>
<span class="co">#  - Computation allocated took 0.17 seconds.</span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ashr/man/get_lfdr.html" class="external-link">get_loglik</a></span><span class="op">(</span><span class="va">mashcontrast.model</span><span class="op">)</span>,digits<span class="op">=</span><span class="fl">10</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co"># [1] -105525.1372</span></code></pre>
<p>Use <code>get_significant_results</code> to find the indices of
effects that are ‘significant’:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_significant_results.html">get_significant_results</a></span><span class="op">(</span><span class="va">mashcontrast.model</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co"># [1] 58</span></code></pre>
<p>The number of false positive is 1.</p>
</div>
<div class="section level2">
<h2 id="the-wrong-way">The wrong way<a class="anchor" aria-label="anchor" href="#the-wrong-way"></a>
</h2>
<p>We fit the mash model ignoring the induced correlation.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">L</span> <span class="op">=</span> <span class="fu"><a href="../reference/contrast_matrix.html">contrast_matrix</a></span><span class="op">(</span><span class="fl">8</span>, ref<span class="op">=</span><span class="fl">8</span><span class="op">)</span>
<span class="va">data.wrong</span> <span class="op">=</span> <span class="fu"><a href="../reference/mash_set_data.html">mash_set_data</a></span><span class="op">(</span>Bhat <span class="op">=</span> <span class="va">simdata</span><span class="op">$</span><span class="va">Chat</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">L</span><span class="op">)</span>, Shat <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="../reference/mash.html">mash</a></span><span class="op">(</span><span class="va">data.wrong</span>, <span class="va">U.c</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">#  - Computing 12000 x 181 likelihood matrix.</span>
<span class="co">#  - Likelihood calculations took 0.30 seconds.</span>
<span class="co">#  - Fitting model with 181 mixture components.</span>
<span class="co">#  - Model fitting took 5.74 seconds.</span>
<span class="co">#  - Computing posterior matrices.</span>
<span class="co">#  - Computation allocated took 0.06 seconds.</span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ashr/man/get_lfdr.html" class="external-link">get_loglik</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>,digits <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co"># [1] -111355.197</span></code></pre>
<p>We can see that the log likelihood is lower, since it does not
consider the induced correlation.</p>
<p>There are 3358 significant effects, 2932 of them are false positives.
The number of false positives is much more than the one include the
induced correlation.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Matthew Stephens, Sarah Urbut, Gao Wang, Yuxin Zou, Peter Carbonetto.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
